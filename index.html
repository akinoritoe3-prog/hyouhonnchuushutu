<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>標本抽出シミュレーター</title>
    <style>
        /* (CSSは変更ありません) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
            background-color: #f7f9fc;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
        }
        .container {
            width: 95%;
            max-width: 600px;
            background: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        .controls {
            width: 100%;
            margin-bottom: 20px;
        }
        .control-group {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .control-group label {
            font-weight: bold;
            font-size: 1.1em;
            margin-right: 15px;
            flex-basis: 40%;
        }
        .control-group input[type="number"] {
            width: 150px;
            padding: 8px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: right;
        }
        .action-button {
            width: 100%;
            padding: 12px;
            font-size: 1.2em;
            font-weight: bold;
            color: #fff;
            background-color: #3498db;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .action-button:hover {
            background-color: #2980b9;
        }
        .secondary-button {
            width: 150px;
            padding: 8px;
            font-size: 1.0em;
            font-weight: bold;
            color: #fff;
            background-color: #2ecc71;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .secondary-button:hover {
            background-color: #27ae60;
        }
        .results {
            width: 100%;
            margin-top: 25px;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        h2 {
            margin-top: 0;
            text-align: center;
            color: #333;
        }
        .result-item {
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f7f9fc;
            padding: 15px;
            border-radius: 5px;
        }
        .result-item span:first-child {
            font-weight: bold;
            color: #2c3e50;
        }
        .result-item span:last-child {
            font-family: monospace;
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1em;
        }
        .result-item.sample-data span:first-child {
            align-self: flex-start;
            flex-shrink: 0; 
        }
        .result-item.sample-data span:last-child {
            font-size: 0.9em; 
            text-align: left; 
            line-height: 1.6;
            color: #34495e; 
            margin-left: 10px;
        }
        
        /* グラフ用のスタイル */
        .chart-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            background-color: #fafafa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #eee;
        }
        canvas {
            background-color: #fff;
            border: 1px solid #ddd;
        }
        .z-display {
            font-family: monospace;
            font-size: 1.1em;
            font-weight: bold;
            color: #e67e22;
            margin-top: 5px;
        }

        .note {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-top: 10px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 5px;
        }
        #errorMessage {
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>標本抽出シミュレーター</h1>
        <p>353,050個のある母集団から100個のサンプルを無作為抽出します。ボタンを押してください。</p>

        <button id="runButton" class="action-button">サンプル抽出</button>
        <p id="errorMessage"></p>

        <div class="results" id="resultsArea" style="display:none;">
            <h2>抽出結果</h2>
            <div class="result-item">
                <span>標本平均 (X̄)</span>
                <span id="sampleMean">---</span>
            </div>
            <div class="result-item">
                <span>標本標準偏差 (s)</span>
                <span id="sampleStdDev">---</span>
            </div>
            <div class="result-item sample-data">
                <span>標本データ</span>
                <span id="sampleDataList">---</span>
            </div>
        </div>
    </div>
    
    <div class="container" id="confidenceArea" style="display:none;">
        <h2>信頼区間の算出</h2>
        
        <div class="chart-container">
            <canvas id="normalDistCanvas" width="300" height="150"></canvas>
            <div class="z-display" id="zValueDisplay">z = ---</div>
        </div>

        <div class="control-group">
            <label for="confidenceLevel">信頼度 (t) %</label>
            <input type="number" id="confidenceLevel" value="95" min="1" max="99" step="1">
        </div>
        
        <button id="calculateCIButton" class="secondary-button">信頼区間を算出</button>
        
        <div class="results">
            <div class="result-item">
                <span>信頼区間</span>
                <span id="confidenceInterval">---</span>
            </div>
        </div>
        <p class="note">
            ※ この計算は、大標本（$n \ge 30$程度）を想定し、t分布の代わりに標準正規分布(Z値)で近似しています。
        </p>
    </div>


    <script>
        // === DOM要素の取得 ===
        const runButton = document.getElementById('runButton');
        const resultsArea = document.getElementById('resultsArea');
        const sampleMeanSpan = document.getElementById('sampleMean');
        const sampleStdDevSpan = document.getElementById('sampleStdDev');
        const sampleDataListSpan = document.getElementById('sampleDataList'); 
        const errorMessageSpan = document.getElementById('errorMessage');

        const confidenceArea = document.getElementById('confidenceArea');
        const confidenceLevelInput = document.getElementById('confidenceLevel');
        const calculateCIButton = document.getElementById('calculateCIButton');
        const confidenceIntervalSpan = document.getElementById('confidenceInterval');
        
        const canvas = document.getElementById('normalDistCanvas');
        const ctx = canvas.getContext('2d');
        const zValueDisplay = document.getElementById('zValueDisplay');

        // === 変数 ===
        let currentMean = null; 
        let currentSampleMean = null; 
        let currentSampleStdDev = null; 
        let currentN = null;

        // === 統計計算 ===
        function generateGaussian(mean, stdDev) {
            let u1, u2;
            do {
                u1 = Math.random();
            } while (u1 === 0);
            u2 = Math.random();
            const z1 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            return mean + stdDev * z1;
        }

        function invZ(p) {
            if (p <= 0 || p >= 1) return NaN;
            const a = [-3.969683028665376e+01, 2.209460984245205e+02, -2.759285104469687e+02, 1.383577518672690e+02, -3.066479806614716e+01, 2.506628277459239e+00];
            const b = [-5.447609879822406e+01, 1.615858368580409e+02, -1.556989798598866e+02, 6.680131188771972e+01, -1.328068155288852e+01];
            const c = [-7.784894002430293e-03, -3.223964580411365e-01, -2.400758277161838e+00, -2.549732539343734e+00, 4.374664141464968e+00, 2.938163982698783e+00];
            const d = [7.784695709041462e-03, 3.224671290700398e-01, 2.445134137142996e+00, 3.754408661907416e+00];
            const p_low = 0.02425;
            const p_high = 1 - p_low;
            let q, r;
            if (p < p_low) {
                q = Math.sqrt(-2 * Math.log(p));
                r = (((((c[0] * q + c[1]) * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) / ((((d[0] * q + d[1]) * q + d[2]) * q + d[3]) * q + 1);
                return r;
            } else if (p < p_high) {
                q = p - 0.5;
                r = q * q;
                r = (((((a[0] * r + a[1]) * r + a[2]) * r + a[3]) * r + a[4]) * r + a[5]) * q / (((((b[0] * r + b[1]) * r + b[2]) * r + b[3]) * r + b[4]) * r + 1);
                return r;
            } else {
                q = Math.sqrt(-2 * Math.log(1 - p));
                r = (((((c[0] * q + c[1]) * q + c[2]) * q + c[3]) * q + c[4]) * q + c[5]) / ((((d[0] * q + d[1]) * q + d[2]) * q + d[3]) * q + 1);
                return -r;
            }
        }

        // === グラフ描画機能 ===
        function drawNormalDistribution() {
            let t = parseInt(confidenceLevelInput.value);
            if (isNaN(t) || t < 1) t = 1;
            if (t > 99) t = 99;
            
            const p = 1 - ((1 - t / 100) / 2);
            const zCrit = Math.abs(invZ(p));

            zValueDisplay.textContent = `z = ±${zCrit.toFixed(2)}`;

            const width = canvas.width;
            const height = canvas.height;
            const padding = 20;
            const plotWidth = width;
            const plotHeight = height - padding;
            
            const minX = -4;
            const maxX = 4;
            const maxY = 0.45;

            const mapX = (x) => {
                return ((x - minX) / (maxX - minX)) * plotWidth;
            };
            const mapY = (y) => {
                return plotHeight - (y / maxY) * plotHeight + 5;
            };

            const normalPDF = (x) => {
                return (1 / Math.sqrt(2 * Math.PI)) * Math.exp(-0.5 * x * x);
            };

            ctx.clearRect(0, 0, width, height);

            ctx.beginPath();
            ctx.moveTo(mapX(-zCrit), mapY(0));
            for (let x = -zCrit; x <= zCrit; x += 0.05) {
                ctx.lineTo(mapX(x), mapY(normalPDF(x)));
            }
            ctx.lineTo(mapX(zCrit), mapY(normalPDF(zCrit)));
            ctx.lineTo(mapX(zCrit), mapY(0));
            ctx.closePath();
            ctx.fillStyle = "rgba(52, 152, 219, 0.4)"; 
            ctx.fill();

            ctx.beginPath();
            let start = true;
            for (let x = minX; x <= maxX; x += 0.05) {
                const px = mapX(x);
                const py = mapY(normalPDF(x));
                if (start) {
                    ctx.moveTo(px, py);
                    start = false;
                } else {
                    ctx.lineTo(px, py);
                }
            }
            ctx.strokeStyle = "#2c3e50";
            ctx.lineWidth = 2;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, mapY(0));
            ctx.lineTo(width, mapY(0));
            ctx.strokeStyle = "#7f8c8d";
            ctx.lineWidth = 1;
            ctx.stroke();
            
            ctx.beginPath();
            ctx.setLineDash([5, 3]);
            ctx.moveTo(mapX(0), mapY(0));
            ctx.lineTo(mapX(0), mapY(normalPDF(0)));
            ctx.strokeStyle = "#95a5a6";
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.fillStyle = "#333";
            ctx.font = "12px Arial";
            ctx.textAlign = "center";
            ctx.fillText("0", mapX(0), height - 2);
            
            if (zCrit > 0.3) {
                ctx.fillText((-zCrit).toFixed(2), mapX(-zCrit), height - 2);
                ctx.fillText((zCrit).toFixed(2), mapX(zCrit), height - 2);
            }
        }

        // === シミュレーション実行 ===
        function runSimulation() {
            const m = 2940;
            const sigma = 340;
            const n = 100;

            errorMessageSpan.style.display = 'none';

            const samples = [];
            for (let i = 0; i < n; i++) {
                samples.push(generateGaussian(m, sigma));
            }

            const sum = samples.reduce((a, b) => a + b, 0);
            const sampleMean = sum / n;

            const sumSqDiff = samples.reduce((total, val) => total + Math.pow(val - sampleMean, 2), 0);
            const variance = sumSqDiff / (n - 1);
            const sampleStdDev = Math.sqrt(variance);

            // 標本平均は整数
            const roundedMean = Math.round(sampleMean);
            
            // 標本標準偏差は有効数字2桁
            const roundedStdDev = parseFloat(sampleStdDev.toPrecision(2));
            
            let roundedSamples = samples.map(val => Math.round(val)); 
            roundedSamples.sort((a, b) => a - b);

            let dataHtml = "";
            for (let i = 0; i < roundedSamples.length; i++) {
                dataHtml += roundedSamples[i];
                if ((i + 1) % 10 === 0 && i !== roundedSamples.length - 1) {
                    dataHtml += ",<br>"; 
                } else if (i !== roundedSamples.length - 1) {
                    dataHtml += ", ";
                }
            }

            resultsArea.style.display = 'block';
            sampleMeanSpan.textContent = roundedMean.toString();
            sampleStdDevSpan.textContent = roundedStdDev.toString();
            sampleDataListSpan.innerHTML = dataHtml; 

            currentMean = m; 
            currentSampleMean = roundedMean;      
            currentSampleStdDev = roundedStdDev; 
            currentN = n;
            
            confidenceArea.style.display = 'block';
            confidenceIntervalSpan.textContent = '---'; 
            
            drawNormalDistribution();
        }

        // === 信頼区間計算 ===
        function calculateConfidenceInterval() {
            if (currentSampleMean === null || currentSampleStdDev === null || currentN === null || currentMean === null) {
                confidenceIntervalSpan.textContent = "先にサンプルを抽出してください";
                return;
            }

            const t = parseInt(confidenceLevelInput.value);
            if (isNaN(t) || t < 1 || t > 99 || !Number.isInteger(t)) {
                confidenceIntervalSpan.textContent = "信頼度は1～99の整数";
                return;
            }

            const p = 1 - ((1 - t / 100) / 2);
            const zValue = invZ(p);
            
            if (currentSampleStdDev === 0) {
                confidenceIntervalSpan.textContent = "標本標準偏差が0のため計算不可";
                return;
            }
            
            const marginOfError = zValue * (currentSampleStdDev / Math.sqrt(currentN));

            const lowerBound = currentSampleMean - marginOfError;
            const upperBound = currentSampleMean + marginOfError;

            // --- 変更点 ---
            // 信頼区間の下限・上限を整数に丸める
            const roundedLower = Math.round(lowerBound);
            const roundedUpper = Math.round(upperBound);

            // 判定も丸めた値で行う
            const isCovered = (roundedLower <= currentMean && currentMean <= roundedUpper);
            const resultMark = isCovered ? '〇' : '✕';

            confidenceIntervalSpan.textContent = `[ ${roundedLower},  ${roundedUpper} ]  ${resultMark}`;
        }

        runButton.addEventListener('click', runSimulation);
        calculateCIButton.addEventListener('click', calculateConfidenceInterval);
        confidenceLevelInput.addEventListener('input', drawNormalDistribution);

    </script>
</body>
</html>
